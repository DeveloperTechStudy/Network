# 3주차_Chap03

# Chapter03 네트워크 계층

## 03-1 LAN을 넘어서는 네트워크 계층

LAN을 넘어서 *다른 네트워크와 통신*하기 위해서는 **네트워크 계층**의 역할이 필수

1. IP 주소를 이용해 송수신지 대상을 지정
2. 라우팅을 통해 다른 네트워크와 통신

### 데이터 링크 계층의 한계

물리 계층 + 데이터 링크 계층으로 LAN을 넘어 통신하기 어렵다*.*

1. 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 **도달 경로를 파악**하기 어렵다.
    
    라우팅: 패킷이 이동할 최적의 경로를 결정하는 것. 물리 계층과 데이터 링크 계층의 장비로 수행X, 네트워크 계층의 장비(ex. 라우터)로 수행 O
    
2. MAC 주소만으로는 모든 네트워크에 속한 **호스트의 위치를 특정**하기 어렵다.
    
    ![택배 배송에서 수신인+수신지 정보 활용하고, 수신지가 우선 고려되는 것과 같다.](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image.png)
    
    택배 배송에서 수신인+수신지 정보 활용하고, 수신지가 우선 고려되는 것과 같다.
    
    | MAC 주소 | IP주소 |
    | --- | --- |
    | 택배의 **수신인** 역할. | 택배의 **수신지** 역할 |
    | 네트워크 인터페이스 (NIC)마다 할당된 일종의 개인 정보와 같다. | 네트워크에서 MAC 주소와 IP주소를 함께 사용하고, IP주소가 우선 활용 |
    | 물리 주소 | 논리 주소 |
    | NIC 마다 할당되는 고정된 주소 | DHCP(Dynamic Host Configuration Protocol)을 통해 자동으로 할당 or 사용자가 직접 할당.
    → 한 호스트가 여러 IP 주소 가질 수 있다. |

### 인터넷 프로토콜

IP (Internet Protocol)

IPv4, IPv6

**IP 주소 형태**

![IPv4](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%201.png)

IPv4

- 4byte(32bit)로 주소 표현.
- 숫자 당 8bit → 0 ~ 255 범위의 4개의 10진수로 표현하며 각 진수는 점(.)으로 구분
- 옥텟(octet): 점으로 구분된 8bit를 의미

**IP의 기능**

1. IP 주소 지정 (IP addressing)
    - IP 주소를 바탕으로 송수신 대상을 지정하는 것
2. IP 단편화 (IP fragmentation)
    - 전송하고자 하는 패킷의 크기가 MTU보다 클 경우, MTU 이하의 복수의 패킷으로 **나누는** 것

* MTU (Maximum Transmission Unit)

- 한 번에 전송 가능한 **IP 패킷의 최대 크기**. 일반적으로 1500byte
- 헤더도 포함.
- MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 재조합된다.

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%202.png)

옵션과 패딩 필드는 선택적으로 존재한다. → IPv4 헤더 길이는 가변적

IPv6 기본 헤더는 40byte로 고정적

**IPv4**

IPv4는 식별자, 플래그, 단편화 오프셋으로 단편화와 재조합 할 수 있고, 
프로토콜 필드로 상위 계층 프로토콜 알 수 있으며
TTL로 패킷의 남은 수명 파악 가능

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%203.png)

1. 식별자 (Idenntifier)
    - 패킷에 할당된 번호
    - 단편화되어 쪼개져서 수신지에 도착한 IPv4 패킷들이 어떤 메시지에서부터 쪼개졌는지 인식하기 위해 사용된다.
2. 플래그 (flag)
    - 3개의 bit로 구성
    
    | 항상 0으로 예약된 bit (미사용) | DF (Don’t Fragment) : IP 단편화 수행 금지 여부
    1일 때 IP단편화 수행 X | MF (More Fragment) : 단편화된 패킷이 더 있는지. 
    0이면 이 패킷이 마지막, 1이면 쪼개진 패킷 더 있음 |
    | --- | --- | --- |
3. 단편화 로프셋 (fragment offset)
    - 패킷이 단편화되기 전, 초기 데이터에서 몇 번째로 떨어진 패킷인지
    - 순서대로 재조합하기 위해 활용됨
    - ex) 단편화 오프셋 1480 - 첫 데이터로부터 1480만큼 떨어진 패킷
4. TTL (Time To Live)
    - 몇 개의 라우터를 거쳤는지 → 무의미한 패킷이 네트워크 상에 남아 있는 것을 방지하기 위해
    - 하나의 라우터 거칠 때마다(홉 마다) 1씩 감소. 0이 되면 폐기
        - 홉(hop): 패킷이 호스트 또는 라우터에 한 번 전달되는 것.
5. 프로토콜
    - 상위 계층의 프로토콜이 무엇인지
    - ex) TCP 6번, UDP 17번
6. 송신지 IP 주소
7. 수신지 IP 주소

**IPv6**

- 이론적으로 할당 가능한 IPv4의 주소는 약 43억개(2^32)
- 스마트폰, 데스크톱, 노트북, 냉장고, Tv 등… → IP 주소 부족!

<aside>
⚙ 2001:0230:abcd:ffff:0000:0000:ffff:1111

</aside>

- [IPv6](https://www.notion.so/3-_Chap03-0d398e3c1ba44a4a9fd09e6373844927?pvs=21)는 16byte(128bit)로 표현
- 콜론(:)으로 구분된 8개 그룹의 16진수로 표기 → 이론적으로 2^128개 할당 가능

1. 다음 헤더 (next header)
    - 상위 계층의 프로토콜 또는 확장 헤더
    - 확장 헤더
        - 기본 헤더와 페이로드 데이터 사이에 위치
        
        ![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%204.png)
        
        - 홉 간 옵션(Hop-by-Hop Options): 송신지에서 수신지에 이르는 모든 경로의 네트워크 장비가 패킷을 검사하도록 함
        - 수신지 옵션(Destination Options): 수신지에서만 패킷을 검사하도록 함
        - 라우팅(Routing): 라우팅 관련 정보 운반
        - 단편(Fragment) : 단편화를 위한 확장 헤더
        - ESP, AH : 암호와와 인증을 위한 확장 헤더
    - 기본 헤더에 단편화 관련 필드가 없고, **단편화 확장 헤더**를 통해 단편화가 이루어진다.
2. 홉 제한 (Hop limit)
    - 패킷의 수명 의미
    - IPv4의 TTL 필드와 비슷
3. 송신지 IP 주소
4. 수신지 IP 주소

### ARP

- Address Resolution Protocol
- 패킷을 올바르게 송신하려면 IP 주소와 MAC주소를 모두 알아야 한다. 이 때 상대 IP 주소는 알지만, **MAC 주소는 알지 못하는 상황**에 쓰이는 프로토콜
- **동일 네트워크** 내에 있는 송수신 대상의 IP 주소를 통해 **MAC 주소** 알아낼 수 있다.

동작 과정

1. ARP 요청
    - 송신지 호스트가 모든 호스트에게 보내는 브로드캐스트 메시지
        - ‘10.0.02와 통신하고 싶은데, 이 분의 MAC 주소가 무엇인가요?’
    - **ARP 요청**이라는 ARP 패킷
2. ARP 응답
    - 수신지 호스트를 제외한 나머지는 자신의 IP주소가 아니므로 이를 무시한다.
    - 수신지 호스트는 자신의 MAC 주소를 담은 유니케스트 메시지인 **ARP 응답**이라는 ARP 패킷을 송신지 호스트에게 전송.
        - ‘제 MAC 주소는 A1:B2:C3:D4:E5:F6 이에요.’
3. ARP 테이블 갱신
    - IP주소와 그에 맞는 MAC 주소 테이블을 대응하는 표
    - 송신지 호스트가 수신지 MAC 주소를 알게 되면, IP주소와 MAC 주소의 **연관 관계를 ARP 테이블에 추가** → 이후 브로드캐스트 ARP 요청 보낼 필요 X
    - 일정 시간 지나면 삭제되고, 임의로 삭제 가능
    - ARP cache, ARP cache table 이라고도 부른다.

* ARP 패킷

![ARP 패킷](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%205.png)

ARP 패킷

- Operation Code: ARP 패킷의 유형. 요청일 경우 1, 응답일 경우 2
- 송신지 하드웨어 주소(Source/Sender Hardware Address)와 수신지 하드웨어 주소(Target Hardware Address) : 송신지와 수신지의 MAC 주소
- 송신지 프로토콜 주소(Source/Sender Protocol Address)와 수신지 프로토콜 주소(Target Protocol Address) : 송신지와 수신지의 IP 주소

### 통신하고자 하는 호스트들이 다른 네트워크에 속해 있을 때..

✅ 네트워크 별로 ARP 수행

1. 호스트 A가 라우터 A의 MAC주소를 모른다면, 
ARP 요청 - ARP 응답을 통해 라우터 A의 MAC 주소를 알아와서 패킷 전송.

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%206.png)

1. 라우터 A가 라우터 B의 MAC 주소를 모른다면 ARP 요청 - ARP 응답 과정을 거쳐 라우터 B의 MAC 주소를 얻어온다.

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%207.png)

1. 라우터 B가 호스트 B의 MAC 주소를 모른다면,
ARP 요청 - ARP 응답 과정을 통해 B의 MAC 주소를 얻어와, 호스트 B에게 패킷을 전달한다.

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%208.png)

### IP 단편화를 피하는 방법

✅ **경로 MTU** 만큼 전송해야 한다.

- IP 단편화는 되도록 하지 않는 것이 좋다.
    - 데이터가 여러 패킷으로 쪼개지면 패킷의 헤더가 많아지고,
    - 불필요한 트래픽 증가와 대역폭 낭비로 이어지며,
    - 패킷 재조합 과정에서 발생하는 부하도 성능 저하 야기할 수 있기 때문.
- **경로 MTU**(Path MTU): IP 단편화 없이 주고 받을 수 있는 최대 크기
- 경로 MTU 발견: 경로 MTU를 구하고, 해당 크기만큼 송수신하여 IP 단편화를 회피하려는 기술. DF 플래그를 설정한 채 동작한다.
- 오늘날의 네트워크에서 대부분 경로 MTU 발견을 지원, 처리 가능한 MTU 크기도 대부분 균일

## 03-2  IP 주소

- 네트워크 계층에서 핵심적인 역할을 맡는다.
- 네트워크 주소와 호스트 주소로 이뤄진다.

### 네트워크 주소와 호스트 주소

| 네트워크 주소 | 호스트 주소 |
| --- | --- |
| 네트워크를 표현하는 부분 | 호스트를 표현하는 부분 |
| 호스트가 속한 특정 네트워크 식별 | 특정 호스트 식별 |
| 네트워크 ID, 네트워크 식별자 (network identifier)로 부른다. | 호스트 ID, 호스트 식별자 (host identifier)로 부른다. |

![네트워크 주소가 16bit, 호스트 주소가 16bit인 IP 주소 예시](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%209.png)

네트워크 주소가 16bit, 호스트 주소가 16bit인 IP 주소 예시

- IP주소에 네트워크 주소와 호스트 주소를 구분하는 범위는 **유동적**일 수 있다.
    - 네트워크 주소가 하나의 옥텟(8bit)이면, 한 네트워크당 호스트 주소 할당에 24bit를 사용 가능.
        
        → 상대적으로 *많은* 호스트에 IP주소 할당 가능, 할당되지 않은 다수의 IP 주소 낭비
        
    - 네트워크 주소가 세 개의 옥텟(24bit)이면, 한 네트워크당 호스트 주소 할당에 8bit를 사용 가능. → 상대적으로 *적은* 호스트에 IP주소 할당 가능, 호스트가 사용할 IP 주소 부족

### 클래스풀 주소 체계

클래스(class)

- 네트워크 크기에 따라 IP주소를 분류하는 기준
- 필요한 호스트 IP 개수에 따라 네트워크 **크기를 가변적으로 조정**해, 네트워크 주소와 호스트 주소 구획 가능

클래스풀 주소 체계 (classdul addressing)

- 클래스를 기반으로 IP 주소를 관리하는 주소 체계
- 클래스를 기반으로 네트워크 주소와 호스트 주소를 구분한다.

![[https://brunch.co.kr/@swimjiy/44](https://brunch.co.kr/@swimjiy/44)](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2010.png)

[https://brunch.co.kr/@swimjiy/44](https://brunch.co.kr/@swimjiy/44)

**A클래스**

- 할당 가능한 호스트 주소가 많다.
- 네트워크 주소가 ‘0’으로 시작하고 1옥텟으로 구성 → 이론상 2^7(128)개의 A클래스 네트워크 존재
- 호스트 주소는 3옥텟으로 구성 → 2^24(약 천만)개의 호스트 주소를 가질 수 있다.
- A클래스로 나타낼 수 있는 IP주소의 최솟값 0.0.0.0, 최댓값 127.125.255.255
- 가장 처음 옥텟의 주소가 **0 ~ 127**일 경우, A클래스 주소임을 짐작

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2011.png)

**B클래스**

- 네트워크 주소는 ‘10’으로 시작하고, 2옥텟으로 구성 →이론상 2^14 개의 B클래스 네트워크 존재
- 호스트 주소도 2옥텟으로 구성 → 2^16개의 호스트 주소 가질 수 있다.
- B클래스로 나타낼 수 있는 IP주소의 최소값은 128.0.0.0, 최대값은 191.255.255.255
- 가장 처음 옥텟의 주소가 **128 ~ 191** 일 경우, B클래스 주소임을 짐작

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2012.png)

**C클래스**

- 네트워크 주소는 ‘110’으로 시작하고, 3옥텟으로 구성 →이론상 2^21개의 C 클래스 네트워크 존대
- 호스트 주소는 1옥텟으로 구성 → 각 네트워크는 2^8개의 호스트 주소 가질 수 있음
- C 클래스로 나타낼 수 있는 IP주소의 최소값은 192.0.0.0, 최대값은 233.255.255.255
- 가장 처음 옥텟의 주소가 **192 ~ 223** 일 경우, C클래스 주소임을 짐작

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2013.png)

### 그러나 호스트의 주소 공간을 모두 사용할 수는 없다..

- 호스트 주소가 전부 0이거나 1인 IP주소는 특정 호스트를 지칭하는 IP주소로 사용될 수 없다.
    - 호스트 주소가 전부 0인 IP 주소는 네트워크 자체를 의미하는 **네트워크 주소**로 사용
    - 호스트 주소가 전부 1인 IP 주소는 **브로드캐스트**를 위한 주소로 사용
- 따라서, 각 클래스별로 실제 할당 가능한 주소의 개수는 **2개를 뺀 개수**이다.

### ⭐클래스리스 주소 체계

- 클래스별 네트워크의 크기가 고정되어 있어 다수의 IP 주소가 낭비될 가능성이 크다.
    - 300명의 직원이 사용할 컴퓨터들을 동일 네트워크로 구성하고 싶을 때, B클래스 주소(65,534개)를 이용해야 한다. → 할당 가능한 호스트 수가 불필요하게 크다.
- 클래스리스 주소 체계 (calssless adddressing): 클래스 개념 없이 네트워크의 영역을 나누어서 호스트에게 IP주소 공간을 할당하는 방식

**서브넷 마스크 (subnet mask)**

- 네트워크와 호스트를 구분 짓는 수단
- IP주소 상에서 네트워크 주소는 1, 호스트 주소는 0으로 표기한 비트열
    - 네트워크 내의 부분적인 네트워크(서브네트워크)를 구분 짓는(마스크) 비트열
- 서브네팅 (subnetting): 서브넷 마스크를 이용해 클래스를 **원하는 크기로 더 잘게 쪼개어** 사용하는 것

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2014.png)

**서브네팅: 비트 AND 연산**

- IP주소와 서브넷 마스크를 AND 연산하여 서브네팅한다.
- 비트 AND 연산: 피연산자가 모두 1인 경우 1, 아닌 경우 0이 되는 연산
- 서브넷 마스크와 IP 주소간에 비트 AND 연산을 수행하면 IP 주소 내의 네트워크 주소를 알아낼 수 있다.

[예시]

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2015.png)

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2016.png)

실제로 할당 가능한 호스트 IP 주소는 192.168.219.1 부터 192.168.219.254 까지 총 254개

**서브넷 마스크 표기: CIDR 표기법**

서브넷 마스크 표기법에는 다음과 같은 두 가지 방법이 있다.

1. 10진수로 직접 표기 - 255.255.255.0
2. IP주소/서브넷 마스크상의 1의 개수 형식으로 표기 - **CIDR 표기법 (Classless Inter-Domain Routing notation)**

예를 들어, C클래스의 기본 서브넷 마스크 255.255.255.0 

→ *2진수*로 표기하면 11111111.11111111.11111111.00000000

→ 1이 총 24개이므로, *CIDR 표기법*에 따르면 192.168.219.103**/24** 

<aside>
❓ 192.168.0.2/25 라는 표기가 있을 때, 어떤 네트워크에 속한 어떤 호스트를 가리킬까?

</aside>

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2017.png)

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2018.png)

→ 10진수 표기하면 192.168.0.0

- 네트워크 주소: 192.168.0.0
- 브로드캐스트 주소: 192.168.0.127
- 할당 가능한 호스트 IP 주소: 192.168.0.1 ~ 192.168.0.126 (126개)

따라서, 192.168.0.2/25 는 *192.168.0.0 네트워크에 속한 2라는 호스트* 의미

![[https://www.calculator.net/ip-subnet-calculator.html](https://www.calculator.net/ip-subnet-calculator.html)](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2019.png)

[https://www.calculator.net/ip-subnet-calculator.html](https://www.calculator.net/ip-subnet-calculator.html)

### 공인 IP주소와 사설 IP주소

**공인 IP 주소 (public IP address)**

- 전 세계에서 고유한 IP 주소
- 네트워크 간의 통신에 사용 (ex. 인터넷 이용할 때 사용되는 IP주소)
- ISP나 공인 IP주소 할당 기관을 통해 받을 수 있다.

**사설 IP 주소 (private IP address)**

- 사설 네트워크에서 사용하기 위한 IP 주소
- 인터넷, 외부 네트워크에 공개되지 않음 → LAN 내의 많은 호스트는 사설 IP 주소를 사용
- 다음 범위에 속하는 IP 주소는 사설 IP 주소로 간주하기로 약속되어 있다.
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
- 할당 주체는 **라우터**
- 할당받은 사설 IP 주소는 해당 호스트가 속한 **사설 네트워크 상에서만 유효**하므로, 다른 네트워크상의 사설 IP주소와 **중복**될 수 있다.
- 일반적으로 네트워크 간의 통신은 사설 IP 주소가 아닌 **공인 IP 주소를 통해** 이뤄짐

**NAT (Network Address Translation)**

- IP 주소를 변환하는 기술
- 사설 IP 주소(네트워크 내부)와 **공인 IP 주소**(네트워크 외부)**를 변환**
- NAT를 통해 사설 IP주소를 사용하는 여러 호스트는 적은 수의 공인 IP 주소를 공유 가능하다.
- 대부분의 라우터와 (가정용) 공유기는 NAT 기능 내장
    - 사설 네트워크의 패킷 속 사설 IP주소는 공유기를 거쳐 공인 IP 주소로 변경
    - 외부 네트워크의 패킷 속 공인 IP주소는 공유기를 거쳐 사설 IP 주소로 변경

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2020.png)

### 정적 IP주소와 동적 IP주소

호스트에 IP 주소를 할당하는 방법

**정적 할당**

- 호스트에 직접 수작업으로 IP주소를 부여하는 방식
- 정적 IP 주소 (static IP Address)
- 부여하고자 하는 IP 주소, 서브넷 마스크, 게이트웨이(라우터) 주소, DNS 주소 입력

**동적 할당**

- 잘못된 IP 주소 입력, 중복된 IP 주소 입력과 같은 정적 할당의 실수를 방지하고자 사용할 수 있는 방식
- 호스트에 IP 주소가 동적으로 할당되는 방식
- 동적 IP 주소 (dynamic IP Address)
- 사용되지 않을 경우 회수, 할당받을 때마다 다른 주소 받을 수 있다.
- 스마트폰이나 노트북 이용 시, 수동으로 IP 주소 설정하지 않고도 인터넷 이용할 수 있는 이유

**DHCP (dynamic host configuration protocol)**

- 동적 할당에 사용되는 프로토콜
- 클라이언트와 DHCP 서버 간 메시지 송수신을 통해 할당이 이뤄진다.
    - 클라이언트: IP 주소를 할당받고자 하는 호스트
    - DHCP 서버: 해당 호스트에게 IP주소를 제공하는 호스트
- DHCP 서버의 역할은 라우터(공유기)가 수행
    - 특정 호스트에 기능 DHCP 기능 추가할 수도 있다.
- 클라이언트에게 할당 가능한 IP 주소 목록을 관리하다가, 클라이언트 요청 시 IP 주소 할당한다.

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2021.png)

- DHCP로 할당받은 동적 IP주소는 사용할 기간(임대 기간)이 정해진다.
- 일반적으로 수 시간 ~ 수일이며 임대 기간이 끝난 IP주소는 DHCP 서버로 반납된다.

### 클라이언트와 DHCP 서버 간에 주고받는 메시지 종류

이 메시지를 순서대로 주고 받으며, 이는 DHCP 패킷을 주고받는 것과 같다.

1. DHCP Discover
    - 클라이언트 → DHCP 서버.
    - DHCP 서버를 찾는 메시지 (브로드캐스트)
    - 메시지 전송 시점에 클라이언트 송신지 IP 주소는 0.0.0.0 으로 설정된다.
2. DHCP Offer
    - DHCP 서버 → 클라이언트
    - 클라이언트에게 할당해 줄 IP 주소 제안
3. DHCP Request
    - 클라이언트→ DHCP 서버.
    - DHCP Offer에 대한 응답 (브로드캐스트)
4. DHCP Acknowledgment (이하 DHCP ACK)
    - DHCP 서버 → 클라이언트
    - 최종 승인과도 같은 메시지.
    - 여기까지 받으면 클라이언트는 이제 할당받은 IP 주소를 자신의 IP주소로 설정한 뒤 임대 기간동안 사용.
- 임대 갱신 (lease renewal): IP 주소 임대 기간이 끝나기 전에 임대 기간을 연장하는 것. 자동으로 두 차례 수행되는 임대 갱신 과정에 모두 실패하면 DHCP 서버로 반납된다.

### 예약주소: 0.0.0.0 vs 127.0.0.1

특수한 목적을 위해 예약된 IP 주소도 있다.

- 루프백 주소 (loopback address) : 자기 자신을 가리키는 특별한 주소. 로컬 호스트라고도 부른다.
 자기 자신을 다른 호스트인 양 간주하여 패킷을 전송할 수 있다. 주로 테스트나 디버깅 용도로 사용된다.
- 0.0.0.0/8 : ‘이 네트워크의 이 호스트’를 지칭하도록 예약되었다. 호스트가 IP 주소를 할당받기 전에 임시로 사용된다.
- 0.0.0.0/0 : ‘모든 임의의 IP 주소’를 의미한다. 패킷이 이동할 경로를 결정하는 라우팅에서 **디폴트 라우트**를 나타내기 위해 사용된다.
패킷을 어떤 IP 주소로 전달할지 결정하기 어려울 경우 기본적으로 패킷을 전달할 경로 의미.

## 03-3  라우팅

- 라우팅: 패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것
- 라우팅 테이블을 만드는 방법에는 1) 정적 라우팅 2) 동적 라우팅 이 있다.

### 라우터

- 네트워크 계층의 핵심 기능 담당
- **L3 스위치**와 라우터는 기능상 유사하여 엄밀히 구분하지 않는 경우가 많다.
- 허브나 스위치보다 높은 계층에 속하는 장치로, **컴퓨터와 기능이 유사**하다.
- 홉(hop): 라우팅 도중 패킷이 호스트↔라우터, 라우터↔라우터 간에 이동하는 하나의 과정.
  패킷은 여러 홉을 거쳐 라우팅 될 수 있다.
- 웹 브라우저에 [www.google.com](http://www.google.com) 을 입력해 구글 웹 페이지를 확인하는 것 
= 웹 브라우저가 구글의 컴퓨터와 패킷을 주고 받는 과정.

### 라우팅 테이블

- 특정 수신지까지 도달하기 위한 정보를 명시한 표로, 라우터가 참고하여 수신지까지의 도달 경로를 판단한다.
- 테이블에 포함되는 정보는 라우팅 방식, 호스트 환경에 따라 달라질 수 있다.
1. 수신지 IP 주소, 서브넷 마스크 : 최종적으로 패킷을 전달할 대상
2. 다음 홉 (next hop): 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP주소/인터페이스
3. 네트워크 인터페이스 : 패킷을 내보낼 통로. 인터페이스 이름(NIC) 이름이 명시되거나 대응하는 IP 주소가 명시된다.
4. 메트릭 (metric) : 해당 경로로 이동하는 데에 드는 비용. 매트릭이 낮은 경로 선호.

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2022.png)

→ 수신지가 192.168.2.0/24인 패킷은 eth0을 통해 192.168.2.1 로 전송하라

![image.png](3%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1_Chap03%200d398e3c1ba44a4a9fd09e6373844927/image%2023.png)

- 디폴트 라우트: 라우팅 테이블에 없는 경로로 패킷을 전송해야 할 때 보낼 경로

→ 수신지가 1.2.3.4 인 패킷을 받으면, 표에 없는 IP 주소이므로 디폴트 라우트, eth2를 통해 192.168.0.1로 전송한다.

### 정적 라우팅과 동적 라우팅

라우팅 테이블이 만들어지는 두 가지 방법

**정적 라우팅 (static routing)**

- 사용자가 수동으로 채워 넣은 라우팅 테이블의 항목을 토대로 라우팅되는 방식

**동적 라우팅 (dynamic routing)**

- 네트워크 규모가 커지면 정적 라우팅만으로는 관리가 어렵다.
- 자동으로 라우팅 테이블 항목을 만들고, 이를 이용하여 라우팅하는 방식 → 테이블 항목이 수시로 변할 수 있다.
- 최적의 경로를 찾기 위해 라우터끼리 정보를 교환하는 과정에서 (동적) 라우팅 프로토콜이 사용됨

### 라우터들의 집단 네트워크, AS

- AS (Autonomous System) : 동일한 라우팅 정책으로 운용되는 라우터들의 집단 네트워크
    - ex) 한 회사나 단체에서 관리하는 라우터 집단
- AS마다 인터넷상에서 고유한 AS 번호(ASN)가 할당된다.
- AS 외부와 통신할 경우 AS 경계에서 AS 내외로 통신을 주고받을 수 있는 **AS 경계 라우터(ASBR)**을 이용한다.

### 라우팅 프로토콜

- 라우터끼리 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜
1. IGP (Interior Gateway Protocol) : AS 내부에서 수행되는 라우팅 프로토콜. RIP, OSFP가 있음.
2. EGP (Exterior Gateway Protocol): AS 외부에서 수행되는 라우팅 프로토콜. BGP가 있음.

**IGP: RIP와  OSPF**

- RIP (Routing Information Protocol) : 최적 경로 선정에 거리 벡터를 사용하는 프로토콜
    - 거리 벡터(distance vector) : 패킷이 경유한 라우터의 수, 즉 홉 수를 기반으로 찾는 프로토콜.
    - 홉 수가 적을수록 테이블상의 매트릭 값도 작아진다.
    - 정보를 주기적으로 교환하며 라우팅 테이블 갱신
- OSPF (Open Shortest Path First) : 최적 경로 선정에 링크 상태를 사용하는 프로토콜
    - 링크 상태 (link state) 데이터베이스에 라우터들의 연결 관계, 연결 비용 등 현재 네트워크의 상태를 그래프로 표현하기 위한 데이터를 저장한다.
    - DB를 기반으로 현재 네트워크 구성을 지도처럼 그린 후 최적의 경로를 선택한다. → 대역폭을 기반으로 매트릭을 계산
    - 네트워크 구성이 변경되었을 때 라우팅 테이블 갱신
    - AS를 **에어리어(area)** 단위로 나누고, 구분된 에어리어 내에서만 링크 상태 공유.
    - 경계에 있는 **ABR (Area Border Router)**가 에어리어간의 연결을 담당.

**EGP: BGP**

- BGP (Border Gateway Protocol) : AS 간의 통신이 가능한 프로토콜
    - eBGP (external BGP) : AS 간의 통신에 사용
    - iBGP (internal BGP) : AS 내의 통신을 위해 사용
- 피어링 (peering) : BGP 메시지를 주고받으 수 있도록 연결된 BGP 라우터
- 정책과 속성이 고려되어, RIP와 OSPF에 비해 최적 경로 결정 과정이 복잡, 일정하지 않다.

BGP의 속성

1. AS-PATH 속성 : 메시지가 수신지에 이르는 과정에서 통과하는 AS들의 목록. 
    - ex) AS1에서 AS3을 거쳐 AS2에 도달하면, AS-PATH는 ‘AS3 AS2’ 가 된다.
2. NEXT-HOP 속성 : 다음 홉, 라우터의 ip 주소를 나타낸다.
3. LOCAL-PREF 속성 : AS 외부 경로에 있어 AS 내부에서(local) 어떤 경로를 선호할지에 대한 척도를 나타내는 속성
    1. LOCAL-PREF 값이 클수록 우선으로 선택된다. 
    2. AS 관리 주체가 설정하는 정책의 영향을 받는다. → 비효율적일지라도 특정 경로를 우선할 수 있다.

BGP의 특성

1. BGP는 AS 간 라우팅을 할 때 거치게 될 ‘라우터’의 수가 아닌 ‘AS’의 수를 고려한다.
2. BGP는 RIP처럼 단순히 수신지에 이르는 ‘거리’가 아닌, 메시지가 어디를 거쳐 어디로 이동하는지를 나타내는 ‘경로’를 고려한다.
    - 메시지가 같은 경로를 무한히 반복하며 이동하는 순환(loop)을 방지하기 위해 
    → 자신의 AS가 AS-PATH에 포함되어 있을 경우 순환으로 간주해 해당 메시지를 버린다.